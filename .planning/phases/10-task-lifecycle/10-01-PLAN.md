---
phase: 10-task-lifecycle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/db/migrations.ts
  - src/main/ipc/database.ts
  - src/shared/types/database.ts
  - src/shared/types/api.ts
  - src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "archived_at column exists in tasks table"
    - "IPC handlers for archive/unarchive/getArchived work"
    - "getAll and getByProject filter out archived tasks"
  artifacts:
    - path: "src/main/db/migrations.ts"
      provides: "Migration version 4 with archived_at"
      contains: "archived_at TEXT"
    - path: "src/main/ipc/database.ts"
      provides: "Archive IPC handlers"
      exports: ["db:tasks:archive", "db:tasks:unarchive", "db:tasks:getArchived"]
    - path: "src/shared/types/database.ts"
      provides: "archived_at field on Task"
      contains: "archived_at"
    - path: "src/preload/index.ts"
      provides: "API bridge methods"
      contains: "archiveTask"
  key_links:
    - from: "src/preload/index.ts"
      to: "src/main/ipc/database.ts"
      via: "ipcRenderer.invoke"
      pattern: "db:tasks:archive"
---

<objective>
Add archived_at column and backend handlers for archive/unarchive/getArchived.

Purpose: Enable soft-delete via archive timestamp. Archived tasks hidden from normal queries.
Output: Migration v4, IPC handlers, updated types, preload API methods.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-task-lifecycle/10-RESEARCH.md

@src/main/db/migrations.ts
@src/main/ipc/database.ts
@src/shared/types/database.ts
@src/shared/types/api.ts
@src/preload/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration v4 with archived_at column</name>
  <files>src/main/db/migrations.ts</files>
  <action>
Add migration version 4 to the migrations array:
- ALTER TABLE tasks ADD COLUMN archived_at TEXT DEFAULT NULL
- CREATE INDEX idx_tasks_archived ON tasks(archived_at)

Follow existing migration pattern (version number, up function).
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Migration v4 exists with archived_at column and index</done>
</task>

<task type="auto">
  <name>Task 2: Add archive IPC handlers and update queries</name>
  <files>src/main/ipc/database.ts</files>
  <action>
Add three new IPC handlers:

1. `db:tasks:archive` (id: string):
   - Use db.transaction to archive task AND all subtasks atomically
   - SQL: UPDATE tasks SET archived_at = datetime('now'), updated_at = datetime('now') WHERE id = ? OR parent_id = ?
   - Return updated task

2. `db:tasks:unarchive` (id: string):
   - Same pattern but SET archived_at = NULL
   - Return updated task

3. `db:tasks:getArchived`:
   - SELECT * FROM tasks WHERE archived_at IS NOT NULL AND parent_id IS NULL ORDER BY archived_at DESC
   - Only top-level tasks (subtasks follow parent)

Update existing handlers:
- `db:tasks:getAll`: Add WHERE archived_at IS NULL
- `db:tasks:getByProject`: Add AND archived_at IS NULL
- `db:tasks:getSubtasks`: Add AND archived_at IS NULL
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Archive/unarchive handlers exist, normal queries filter archived tasks</done>
</task>

<task type="auto">
  <name>Task 3: Update types and preload API</name>
  <files>src/shared/types/database.ts, src/shared/types/api.ts, src/preload/index.ts</files>
  <action>
1. In src/shared/types/database.ts, add to Task interface:
   archived_at: string | null

2. In src/shared/types/api.ts, add to ElectronAPI.db:
   archiveTask: (id: string) => Promise<Task>
   unarchiveTask: (id: string) => Promise<Task>
   getArchivedTasks: () => Promise<Task[]>

3. In src/preload/index.ts, add to api.db object:
   archiveTask: (id) => ipcRenderer.invoke('db:tasks:archive', id),
   unarchiveTask: (id) => ipcRenderer.invoke('db:tasks:unarchive', id),
   getArchivedTasks: () => ipcRenderer.invoke('db:tasks:getArchived'),
  </action>
  <verify>npm run typecheck passes</verify>
  <done>Task type has archived_at, API has archive methods</done>
</task>

</tasks>

<verification>
1. npm run typecheck - no errors
2. npm run lint - no errors
3. Start app, create task, verify task appears in kanban (not archived)
</verification>

<success_criteria>
- Migration v4 adds archived_at column
- Archive/unarchive handlers work with transaction
- Normal task queries exclude archived tasks
- Types updated throughout stack
</success_criteria>

<output>
After completion, create `.planning/phases/10-task-lifecycle/10-01-SUMMARY.md`
</output>

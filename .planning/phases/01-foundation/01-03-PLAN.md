---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/shared/types/api.ts
  - src/preload/index.ts
  - src/preload/index.d.ts
  - src/main/ipc/database.ts
  - src/main/index.ts
  - src/renderer/src/env.d.ts
autonomous: true

must_haves:
  truths:
    - "window.api.db methods exist and are callable from renderer"
    - "window.require is undefined (security)"
    - "window.process is undefined (security)"
    - "IPC calls return data from database"
  artifacts:
    - path: "src/shared/types/api.ts"
      provides: "Typed IPC API definition"
      exports: ["ElectronAPI"]
    - path: "src/preload/index.ts"
      provides: "contextBridge API exposure"
      contains: "contextBridge.exposeInMainWorld"
    - path: "src/main/ipc/database.ts"
      provides: "IPC handlers for database operations"
      exports: ["registerDatabaseHandlers"]
  key_links:
    - from: "src/preload/index.ts"
      to: "src/main/ipc/database.ts"
      via: "ipcRenderer.invoke channel names"
      pattern: "db:.*"
    - from: "src/main/index.ts"
      to: "src/main/ipc/database.ts"
      via: "registerDatabaseHandlers call"
      pattern: "registerDatabaseHandlers"
---

<objective>
Create typed IPC layer connecting renderer to database and verify security baseline.

Purpose: Enable React frontend to access data through secure contextBridge API.
Output: Working window.api with typed methods, verified security configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create typed IPC API and handlers</name>
  <files>
    - src/shared/types/api.ts
    - src/preload/index.ts
    - src/preload/index.d.ts
    - src/main/ipc/database.ts
    - src/main/index.ts
    - src/renderer/src/env.d.ts
  </files>
  <action>
    1. Create src/shared/types/api.ts defining the API shape:
       ```typescript
       import type { Task, Project, WorkspaceItem } from './database'

       export interface CreateTaskInput {
         projectId: string
         title: string
         description?: string
         status?: string
         priority?: number
         dueDate?: string
       }

       export interface CreateProjectInput {
         name: string
         color: string
       }

       export interface ElectronAPI {
         db: {
           // Projects
           getProjects: () => Promise<Project[]>
           createProject: (data: CreateProjectInput) => Promise<Project>

           // Tasks
           getTasks: () => Promise<Task[]>
           getTasksByProject: (projectId: string) => Promise<Task[]>
           createTask: (data: CreateTaskInput) => Promise<Task>
         }
       }
       ```

    2. Create src/main/ipc/database.ts with handlers:
       ```typescript
       import { ipcMain } from 'electron'
       import { getDatabase } from '../db'
       import type { CreateTaskInput, CreateProjectInput } from '../../shared/types/api'

       export function registerDatabaseHandlers(): void {
         const db = getDatabase()

         // Projects
         ipcMain.handle('db:projects:getAll', () => {
           return db.prepare('SELECT * FROM projects ORDER BY name').all()
         })

         ipcMain.handle('db:projects:create', (_, data: CreateProjectInput) => {
           const id = crypto.randomUUID()
           const stmt = db.prepare(`
             INSERT INTO projects (id, name, color)
             VALUES (?, ?, ?)
           `)
           stmt.run(id, data.name, data.color)
           return db.prepare('SELECT * FROM projects WHERE id = ?').get(id)
         })

         // Tasks
         ipcMain.handle('db:tasks:getAll', () => {
           return db.prepare('SELECT * FROM tasks ORDER BY created_at DESC').all()
         })

         ipcMain.handle('db:tasks:getByProject', (_, projectId: string) => {
           return db.prepare('SELECT * FROM tasks WHERE project_id = ? ORDER BY created_at DESC').all(projectId)
         })

         ipcMain.handle('db:tasks:create', (_, data: CreateTaskInput) => {
           const id = crypto.randomUUID()
           const stmt = db.prepare(`
             INSERT INTO tasks (id, project_id, title, description, status, priority, due_date)
             VALUES (?, ?, ?, ?, ?, ?, ?)
           `)
           stmt.run(
             id,
             data.projectId,
             data.title,
             data.description ?? null,
             data.status ?? 'inbox',
             data.priority ?? 3,
             data.dueDate ?? null
           )
           return db.prepare('SELECT * FROM tasks WHERE id = ?').get(id)
         })
       }
       ```

    3. Update src/preload/index.ts to expose API via contextBridge:
       ```typescript
       import { contextBridge, ipcRenderer } from 'electron'
       import type { ElectronAPI } from '../shared/types/api'

       const api: ElectronAPI = {
         db: {
           getProjects: () => ipcRenderer.invoke('db:projects:getAll'),
           createProject: (data) => ipcRenderer.invoke('db:projects:create', data),
           getTasks: () => ipcRenderer.invoke('db:tasks:getAll'),
           getTasksByProject: (projectId) => ipcRenderer.invoke('db:tasks:getByProject', projectId),
           createTask: (data) => ipcRenderer.invoke('db:tasks:create', data),
         }
       }

       contextBridge.exposeInMainWorld('api', api)
       ```

    4. Create/update src/renderer/src/env.d.ts for window.api typing:
       ```typescript
       /// <reference types="vite/client" />

       import type { ElectronAPI } from '../../shared/types/api'

       declare global {
         interface Window {
           api: ElectronAPI
         }
       }
       ```

    5. Update src/main/index.ts:
       - Import registerDatabaseHandlers from './ipc/database'
       - Call registerDatabaseHandlers() after getDatabase() in app.whenReady()

    6. Verify main process security settings in BrowserWindow webPreferences:
       - nodeIntegration: false (or not set, defaults to false)
       - contextIsolation: true
       - sandbox: true

       If any are wrong, fix them.
  </action>
  <verify>
    npm run dev
    Open DevTools (Cmd+Option+I)
    Console: window.api -> should show {db: {...}}
    Console: window.api.db.getProjects() -> should return []
    Console: window.require -> should be undefined
    Console: window.process -> should be undefined
  </verify>
  <done>Typed IPC API working, security baseline verified</done>
</task>

<task type="auto">
  <name>Task 2: Add UI test for IPC + verify full foundation</name>
  <files>
    - src/renderer/src/App.tsx
  </files>
  <action>
    1. Update App.tsx to demonstrate working IPC:
       ```tsx
       import { useState, useEffect } from 'react'
       import type { Project } from '../../shared/types/database'

       function App() {
         const [projects, setProjects] = useState<Project[]>([])
         const [status, setStatus] = useState<string>('Loading...')

         useEffect(() => {
           // Test IPC on mount
           window.api.db.getProjects()
             .then(p => {
               setProjects(p)
               setStatus(`Found ${p.length} projects`)
             })
             .catch(err => setStatus(`Error: ${err.message}`))
         }, [])

         const createTestProject = async () => {
           const project = await window.api.db.createProject({
             name: 'Test Project',
             color: '#3b82f6'
           })
           setProjects([...projects, project])
           setStatus(`Created project: ${project.name}`)
         }

         return (
           <div className="flex min-h-screen flex-col items-center justify-center gap-4 bg-slate-900 p-8">
             <h1 className="text-4xl font-bold text-white">Focus</h1>
             <p className="text-slate-400">{status}</p>
             <button
               onClick={createTestProject}
               className="rounded bg-blue-600 px-4 py-2 text-white hover:bg-blue-700"
             >
               Create Test Project
             </button>
             {projects.length > 0 && (
               <ul className="mt-4 space-y-2">
                 {projects.map(p => (
                   <li key={p.id} className="text-white">
                     <span
                       className="mr-2 inline-block h-3 w-3 rounded-full"
                       style={{ backgroundColor: p.color }}
                     />
                     {p.name}
                   </li>
                 ))}
               </ul>
             )}
           </div>
         )
       }

       export default App
       ```

    2. Test the full flow:
       - npm run dev
       - App shows "Found 0 projects" initially
       - Click "Create Test Project"
       - App shows "Created project: Test Project"
       - Project appears in list with blue dot
       - Refresh app (Cmd+R) - project persists

    3. Final security check in DevTools console:
       - window.require === undefined
       - window.process === undefined
       - window.api exists with db methods
       - No Node.js globals exposed
  </action>
  <verify>
    npm run dev
    1. App shows project count on load
    2. "Create Test Project" creates project and shows it
    3. Refresh preserves the project (data persisted)
    4. DevTools console:
       - typeof window.require === 'undefined'
       - typeof window.process === 'undefined'
       - typeof window.api.db.getProjects === 'function'
  </verify>
  <done>Full Phase 1 foundation verified: Electron + React + SQLite + IPC + Security</done>
</task>

</tasks>

<verification>
1. window.api.db methods callable from renderer
2. IPC calls return real data from SQLite
3. Security baseline: nodeIntegration false, contextIsolation true, sandbox true
4. No Node globals (require, process) in renderer
5. Data persists across app restart
</verification>

<success_criteria>
Phase 1 complete when:
- App launches and displays React UI in Electron window
- SQLite database created in userData directory with tasks, projects, workspace_items tables
- Preload script exposes typed IPC API (contextBridge)
- Security baseline verified: nodeIntegration false, contextIsolation true, sandbox true
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>

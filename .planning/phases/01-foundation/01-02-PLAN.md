---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - package.json
  - electron.vite.config.ts
  - src/main/db/index.ts
  - src/main/db/migrations.ts
  - src/shared/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Database file created in userData directory on app launch"
    - "Tables tasks, projects, workspace_items exist with correct schema"
    - "Database uses WAL mode for performance"
  artifacts:
    - path: "src/main/db/index.ts"
      provides: "Database singleton and initialization"
      exports: ["getDatabase", "closeDatabase"]
    - path: "src/main/db/migrations.ts"
      provides: "Schema migrations using user_version"
      exports: ["runMigrations"]
    - path: "src/shared/types/database.ts"
      provides: "TypeScript types for entities"
      exports: ["Task", "Project", "WorkspaceItem"]
  key_links:
    - from: "src/main/db/index.ts"
      to: "app.getPath('userData')"
      via: "getDatabasePath function"
      pattern: "app\\.getPath.*userData"
    - from: "src/main/index.ts"
      to: "src/main/db/index.ts"
      via: "getDatabase call on app ready"
      pattern: "getDatabase\\(\\)"
---

<objective>
Set up better-sqlite3 with electron-rebuild and create database layer with migrations.

Purpose: Establish data persistence foundation. All features depend on database.
Output: SQLite database auto-created on launch with correct schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure better-sqlite3</name>
  <files>
    - package.json
    - electron.vite.config.ts
  </files>
  <action>
    1. Install better-sqlite3 and rebuild tool:
       `npm install better-sqlite3`
       `npm install -D @electron/rebuild`

    2. Add postinstall script to package.json:
       ```json
       "scripts": {
         "postinstall": "electron-rebuild -f -w better-sqlite3"
       }
       ```

    3. Run rebuild manually now:
       `npx electron-rebuild -f -w better-sqlite3`

    4. Mark better-sqlite3 as external in electron.vite.config.ts main section:
       ```typescript
       main: {
         plugins: [externalizeDepsPlugin()],
         build: {
           rollupOptions: {
             external: ['better-sqlite3']
           }
         }
       }
       ```

    5. Test: `npm run dev` should launch without native module errors.

    Note: If NODE_MODULE_VERSION mismatch error occurs, delete node_modules and run `npm install` again (postinstall will rebuild).
  </action>
  <verify>
    npm run dev
    No "module compiled against different Node.js version" errors
    App launches successfully
  </verify>
  <done>better-sqlite3 installed and rebuilt for Electron's Node version</done>
</task>

<task type="auto">
  <name>Task 2: Create database layer with migrations</name>
  <files>
    - src/main/db/index.ts
    - src/main/db/migrations.ts
    - src/shared/types/database.ts
    - src/main/index.ts
  </files>
  <action>
    1. Create src/shared/types/database.ts with entity types:
       ```typescript
       export type TaskStatus = 'inbox' | 'backlog' | 'todo' | 'in_progress' | 'review' | 'done'

       export interface Task {
         id: string
         project_id: string
         parent_id: string | null
         title: string
         description: string | null
         status: TaskStatus
         priority: number  // 1-5, default 3
         due_date: string | null
         blocked_reason: string | null
         created_at: string
         updated_at: string
       }

       export interface Project {
         id: string
         name: string
         color: string
         created_at: string
         updated_at: string
       }

       export type WorkspaceItemType = 'chat' | 'browser' | 'document'

       export interface WorkspaceItem {
         id: string
         task_id: string
         type: WorkspaceItemType
         name: string
         content: string | null
         url: string | null
         created_at: string
         updated_at: string
       }
       ```

    2. Create src/main/db/migrations.ts:
       ```typescript
       import Database from 'better-sqlite3'

       interface Migration {
         version: number
         up: (db: Database.Database) => void
       }

       const migrations: Migration[] = [
         {
           version: 1,
           up: (db) => {
             db.exec(`
               CREATE TABLE projects (
                 id TEXT PRIMARY KEY,
                 name TEXT NOT NULL,
                 color TEXT NOT NULL,
                 created_at TEXT NOT NULL DEFAULT (datetime('now')),
                 updated_at TEXT NOT NULL DEFAULT (datetime('now'))
               );

               CREATE TABLE tasks (
                 id TEXT PRIMARY KEY,
                 project_id TEXT NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
                 parent_id TEXT REFERENCES tasks(id) ON DELETE CASCADE,
                 title TEXT NOT NULL,
                 description TEXT,
                 status TEXT NOT NULL DEFAULT 'inbox',
                 priority INTEGER NOT NULL DEFAULT 3,
                 due_date TEXT,
                 blocked_reason TEXT,
                 created_at TEXT NOT NULL DEFAULT (datetime('now')),
                 updated_at TEXT NOT NULL DEFAULT (datetime('now'))
               );

               CREATE TABLE workspace_items (
                 id TEXT PRIMARY KEY,
                 task_id TEXT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
                 type TEXT NOT NULL,
                 name TEXT NOT NULL,
                 content TEXT,
                 url TEXT,
                 created_at TEXT NOT NULL DEFAULT (datetime('now')),
                 updated_at TEXT NOT NULL DEFAULT (datetime('now'))
               );

               CREATE INDEX idx_tasks_project ON tasks(project_id);
               CREATE INDEX idx_tasks_parent ON tasks(parent_id);
               CREATE INDEX idx_tasks_status ON tasks(status);
               CREATE INDEX idx_workspace_task ON workspace_items(task_id);
             `)
           }
         }
       ]

       export function runMigrations(db: Database.Database): void {
         const currentVersion = db.pragma('user_version', { simple: true }) as number

         for (const migration of migrations) {
           if (migration.version > currentVersion) {
             db.transaction(() => {
               migration.up(db)
               db.pragma(`user_version = ${migration.version}`)
             })()
             console.log(`Migration ${migration.version} applied`)
           }
         }
       }
       ```

    3. Create src/main/db/index.ts:
       ```typescript
       import { app } from 'electron'
       import Database from 'better-sqlite3'
       import path from 'path'
       import { runMigrations } from './migrations'

       const getDatabasePath = (): string => {
         const userDataPath = app.getPath('userData')
         const dbName = app.isPackaged ? 'focus.sqlite' : 'focus.dev.sqlite'
         return path.join(userDataPath, dbName)
       }

       let db: Database.Database | null = null

       export function getDatabase(): Database.Database {
         if (!db) {
           const dbPath = getDatabasePath()
           console.log('Database path:', dbPath)
           db = new Database(dbPath)
           db.pragma('journal_mode = WAL')
           db.pragma('foreign_keys = ON')
           runMigrations(db)
         }
         return db
       }

       export function closeDatabase(): void {
         if (db) {
           db.close()
           db = null
         }
       }
       ```

    4. Update src/main/index.ts to initialize database on app ready:
       - Import getDatabase and closeDatabase
       - Call getDatabase() after app.whenReady()
       - Call closeDatabase() in app.on('will-quit')

    5. Test: `npm run dev` should show "Database path: ..." in terminal.
       Check that database file exists at that path.
  </action>
  <verify>
    npm run dev
    Terminal shows "Database path: /Users/.../Library/Application Support/focus/focus.dev.sqlite"
    Terminal shows "Migration 1 applied" on first run
    Database file exists at that path (check with ls or file browser)
    sqlite3 CLI can open the file and show tables: sqlite3 path/to/focus.dev.sqlite ".tables"
  </verify>
  <done>Database layer created with auto-migration on startup</done>
</task>

</tasks>

<verification>
1. `npm run dev` launches without native module errors
2. Database file created in userData directory
3. `sqlite3 <db-path> ".tables"` shows: projects tasks workspace_items
4. `sqlite3 <db-path> "PRAGMA user_version"` shows: 1
5. `sqlite3 <db-path> "PRAGMA journal_mode"` shows: wal
</verification>

<success_criteria>
- better-sqlite3 works with Electron (no ABI mismatch)
- Database auto-created in userData on first launch
- Schema has all three tables with indexes
- Migrations are idempotent (second run doesn't error)
- Ready for IPC layer in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>

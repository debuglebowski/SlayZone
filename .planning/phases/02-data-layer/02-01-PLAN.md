---
phase: 02-data-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/types/api.ts
  - src/main/ipc/database.ts
  - src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "window.api.db.updateTask can modify any task field"
    - "window.api.db.deleteTask removes task from database"
    - "window.api.db.updateProject can modify name/color"
    - "window.api.db.deleteProject removes project from database"
    - "window.api.db.getTask retrieves single task by ID"
  artifacts:
    - path: "src/shared/types/api.ts"
      provides: "UpdateTaskInput, UpdateProjectInput types"
      exports: ["UpdateTaskInput", "UpdateProjectInput", "ElectronAPI"]
    - path: "src/main/ipc/database.ts"
      provides: "IPC handlers for update/delete"
      contains: "db:tasks:update"
    - path: "src/preload/index.ts"
      provides: "Renderer API bindings for update/delete"
      contains: "updateTask"
  key_links:
    - from: "src/preload/index.ts"
      to: "src/main/ipc/database.ts"
      via: "ipcRenderer.invoke channel names"
      pattern: "db:tasks:(update|delete)"
    - from: "src/shared/types/api.ts"
      to: "src/main/ipc/database.ts"
      via: "Type imports for handler params"
      pattern: "UpdateTaskInput"
---

<objective>
Extend IPC layer with update/delete handlers for tasks and projects.

Purpose: Enable CRUD operations needed for Phase 2 UI.
Output: Full CRUD API available via window.api.db.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-data-layer/02-RESEARCH.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add update/delete types and handlers</name>
  <files>
    - src/shared/types/api.ts
    - src/main/ipc/database.ts
    - src/preload/index.ts
  </files>
  <action>
    1. Update src/shared/types/api.ts - add input types and extend ElectronAPI:
       ```typescript
       import type { Task, Project, TaskStatus } from './database'

       // Existing CreateTaskInput, CreateProjectInput...

       export interface UpdateTaskInput {
         id: string
         title?: string
         description?: string | null
         status?: TaskStatus
         priority?: number
         dueDate?: string | null
         blockedReason?: string | null
       }

       export interface UpdateProjectInput {
         id: string
         name?: string
         color?: string
       }

       export interface ElectronAPI {
         db: {
           // Projects
           getProjects: () => Promise<Project[]>
           createProject: (data: CreateProjectInput) => Promise<Project>
           updateProject: (data: UpdateProjectInput) => Promise<Project>
           deleteProject: (id: string) => Promise<boolean>

           // Tasks
           getTasks: () => Promise<Task[]>
           getTasksByProject: (projectId: string) => Promise<Task[]>
           getTask: (id: string) => Promise<Task | null>
           createTask: (data: CreateTaskInput) => Promise<Task>
           updateTask: (data: UpdateTaskInput) => Promise<Task>
           deleteTask: (id: string) => Promise<boolean>
         }
       }
       ```

    2. Update src/main/ipc/database.ts - add handlers:
       - db:tasks:get - get single task by ID
       - db:tasks:update - dynamic SET clause from provided fields only
       - db:tasks:delete - delete by ID, return boolean
       - db:projects:update - dynamic SET clause
       - db:projects:delete - delete by ID, return boolean

       For update handlers, build SET clause dynamically:
       ```typescript
       ipcMain.handle('db:tasks:update', (_, data: UpdateTaskInput) => {
         const fields: string[] = []
         const values: unknown[] = []

         if (data.title !== undefined) { fields.push('title = ?'); values.push(data.title) }
         if (data.description !== undefined) { fields.push('description = ?'); values.push(data.description) }
         if (data.status !== undefined) { fields.push('status = ?'); values.push(data.status) }
         if (data.priority !== undefined) { fields.push('priority = ?'); values.push(data.priority) }
         if (data.dueDate !== undefined) { fields.push('due_date = ?'); values.push(data.dueDate) }
         if (data.blockedReason !== undefined) { fields.push('blocked_reason = ?'); values.push(data.blockedReason) }

         if (fields.length === 0) {
           return db.prepare('SELECT * FROM tasks WHERE id = ?').get(data.id)
         }

         fields.push("updated_at = datetime('now')")
         values.push(data.id)

         db.prepare(`UPDATE tasks SET ${fields.join(', ')} WHERE id = ?`).run(...values)
         return db.prepare('SELECT * FROM tasks WHERE id = ?').get(data.id)
       })
       ```

       For delete handlers:
       ```typescript
       ipcMain.handle('db:tasks:delete', (_, id: string) => {
         const result = db.prepare('DELETE FROM tasks WHERE id = ?').run(id)
         return result.changes > 0
       })
       ```

    3. Update src/preload/index.ts - add new methods to api object:
       ```typescript
       const api: ElectronAPI = {
         db: {
           // Existing...
           getTask: (id) => ipcRenderer.invoke('db:tasks:get', id),
           updateTask: (data) => ipcRenderer.invoke('db:tasks:update', data),
           deleteTask: (id) => ipcRenderer.invoke('db:tasks:delete', id),
           updateProject: (data) => ipcRenderer.invoke('db:projects:update', data),
           deleteProject: (id) => ipcRenderer.invoke('db:projects:delete', id),
         }
       }
       ```
  </action>
  <verify>
    npm run dev
    Open DevTools console:
    - typeof window.api.db.updateTask === 'function'
    - typeof window.api.db.deleteTask === 'function'
    - typeof window.api.db.getTask === 'function'
    - typeof window.api.db.updateProject === 'function'
    - typeof window.api.db.deleteProject === 'function'
  </verify>
  <done>All update/delete IPC methods exist and are callable</done>
</task>

<task type="auto">
  <name>Task 2: Verify IPC layer with console tests</name>
  <files>
    (no files - verification only)
  </files>
  <action>
    Test full CRUD cycle in DevTools console:

    1. Create a project:
       ```javascript
       const proj = await window.api.db.createProject({ name: 'CRUD Test', color: '#10b981' })
       console.log('Created:', proj)
       ```

    2. Create a task:
       ```javascript
       const task = await window.api.db.createTask({
         projectId: proj.id,
         title: 'Test Task',
         status: 'inbox',
         priority: 3
       })
       console.log('Created:', task)
       ```

    3. Update the task:
       ```javascript
       const updated = await window.api.db.updateTask({
         id: task.id,
         title: 'Updated Title',
         status: 'todo',
         blockedReason: 'Waiting for approval'
       })
       console.log('Updated:', updated)
       // Verify: updated.title === 'Updated Title'
       // Verify: updated.status === 'todo'
       // Verify: updated.blocked_reason === 'Waiting for approval'
       ```

    4. Get single task:
       ```javascript
       const fetched = await window.api.db.getTask(task.id)
       console.log('Fetched:', fetched)
       // Verify: fetched.id === task.id
       ```

    5. Delete the task:
       ```javascript
       const deleted = await window.api.db.deleteTask(task.id)
       console.log('Deleted:', deleted) // true
       const gone = await window.api.db.getTask(task.id)
       console.log('After delete:', gone) // null
       ```

    6. Update project:
       ```javascript
       const updatedProj = await window.api.db.updateProject({
         id: proj.id,
         name: 'Renamed Project',
         color: '#ef4444'
       })
       console.log('Updated project:', updatedProj)
       ```

    7. Delete project:
       ```javascript
       const projDeleted = await window.api.db.deleteProject(proj.id)
       console.log('Project deleted:', projDeleted) // true
       ```

    All tests should pass. If any fail, debug and fix.
  </action>
  <verify>
    Run all console tests above. Expected results:
    - Create returns objects with IDs
    - Update modifies only specified fields
    - Delete returns true
    - Get after delete returns null
  </verify>
  <done>Full CRUD cycle verified for tasks and projects</done>
</task>

</tasks>

<verification>
1. All 5 new IPC methods exist on window.api.db
2. updateTask modifies only provided fields (partial update)
3. deleteTask/deleteProject return boolean
4. getTask returns null for non-existent ID
5. TypeScript types match implementation
</verification>

<success_criteria>
- window.api.db has: getTask, updateTask, deleteTask, updateProject, deleteProject
- Partial updates work (changing title doesn't clear description)
- Delete operations return true/false based on changes
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-layer/02-01-SUMMARY.md`
</output>

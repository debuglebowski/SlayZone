---
phase: 08-theme-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/ipc/theme.ts
  - src/main/index.ts
  - src/preload/index.ts
  - src/shared/types/api.ts
autonomous: true

must_haves:
  truths:
    - "Theme preference persists across app restarts"
    - "System theme changes propagate when set to system"
    - "nativeTheme controls both CSS and Electron chrome"
  artifacts:
    - path: "src/main/ipc/theme.ts"
      provides: "nativeTheme IPC handlers"
      exports: ["registerThemeHandlers"]
    - path: "src/preload/index.ts"
      provides: "theme API bridge"
      contains: "theme:"
  key_links:
    - from: "src/main/index.ts"
      to: "src/main/ipc/theme.ts"
      via: "registerThemeHandlers call"
      pattern: "registerThemeHandlers"
    - from: "src/preload/index.ts"
      to: "main process"
      via: "ipcRenderer.invoke"
      pattern: "theme:set"
---

<objective>
Wire Electron nativeTheme API through IPC to renderer.

Purpose: Foundation for theme control - main process owns nativeTheme, renderer can query/set via IPC
Output: Working IPC channel for theme operations, persisted to settings table
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/08-theme-system/08-RESEARCH.md
@src/main/index.ts
@src/preload/index.ts
@src/shared/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme IPC handlers</name>
  <files>
    src/main/ipc/theme.ts
    src/main/index.ts
  </files>
  <action>
Create `src/main/ipc/theme.ts`:
- Import nativeTheme, ipcMain, BrowserWindow from electron
- Import getDatabase from ../db
- Export `registerThemeHandlers()` function
- IPC handlers:
  - `theme:get-effective` -> returns 'dark' | 'light' based on shouldUseDarkColors
  - `theme:get-source` -> returns nativeTheme.themeSource ('light' | 'dark' | 'system')
  - `theme:set` -> sets themeSource, persists to settings table (key: 'theme'), returns effective theme
- Listen to nativeTheme 'updated' event -> broadcast 'theme:changed' to all windows

Modify `src/main/index.ts`:
- Import registerThemeHandlers and nativeTheme
- BEFORE registerDatabaseHandlers(): load theme from settings table, set nativeTheme.themeSource if exists
- Call registerThemeHandlers() after registerDatabaseHandlers()

Key: Load persisted theme BEFORE creating window to prevent flash.
  </action>
  <verify>
Build succeeds: `npm run build`
No TypeScript errors in main process files
  </verify>
  <done>
Theme IPC handlers registered
Persisted theme loaded on startup before window creation
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend preload bridge with theme API</name>
  <files>
    src/preload/index.ts
    src/shared/types/api.ts
  </files>
  <action>
Modify `src/shared/types/api.ts`:
- Add type: `type Theme = 'light' | 'dark'`
- Add type: `type ThemePreference = 'light' | 'dark' | 'system'`
- Add to ElectronAPI interface:
```typescript
theme: {
  getEffective: () => Promise<Theme>
  getSource: () => Promise<ThemePreference>
  set: (theme: ThemePreference) => Promise<Theme>
  onChange: (callback: (theme: Theme) => void) => () => void
}
```

Modify `src/preload/index.ts`:
- Add theme object to api const:
```typescript
theme: {
  getEffective: () => ipcRenderer.invoke('theme:get-effective'),
  getSource: () => ipcRenderer.invoke('theme:get-source'),
  set: (theme: 'light' | 'dark' | 'system') => ipcRenderer.invoke('theme:set', theme),
  onChange: (callback: (theme: 'light' | 'dark') => void) => {
    const handler = (_event: unknown, theme: 'light' | 'dark') => callback(theme)
    ipcRenderer.on('theme:changed', handler)
    return () => ipcRenderer.removeListener('theme:changed', handler)
  }
}
```
  </action>
  <verify>
`npm run build` succeeds
TypeScript compiles without errors
  </verify>
  <done>
window.api.theme available with getEffective, getSource, set, onChange methods
Types exported for Theme and ThemePreference
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Main process creates theme.ts IPC handlers
3. Preload exposes theme API
4. Types compile correctly
</verification>

<success_criteria>
- Main process can get/set nativeTheme via IPC
- Theme persisted to settings table
- Theme loaded on startup before window creation
- Preload bridge exposes theme API to renderer
- System theme change events broadcast to renderer
</success_criteria>

<output>
After completion, create `.planning/phases/08-theme-system/08-01-SUMMARY.md`
</output>

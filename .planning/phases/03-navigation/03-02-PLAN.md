---
phase: 03-navigation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/db/migrations.ts
  - src/main/ipc/database.ts
  - src/preload/index.ts
  - src/shared/types/api.ts
  - src/shared/types/database.ts
autonomous: true

must_haves:
  truths:
    - "Tags table exists with id, name, color columns"
    - "Settings table exists with key/value storage"
    - "Tags CRUD available via IPC"
    - "Settings get/set available via IPC"
  artifacts:
    - path: "src/main/db/migrations.ts"
      provides: "Schema migration v2"
      contains: "CREATE TABLE tags"
    - path: "src/main/ipc/database.ts"
      provides: "Tags and settings handlers"
      contains: "db:tags:getAll"
    - path: "src/shared/types/database.ts"
      provides: "Tag type definition"
      contains: "interface Tag"
  key_links:
    - from: "src/preload/index.ts"
      to: "src/main/ipc/database.ts"
      via: "IPC channel names"
      pattern: "db:tags:"
    - from: "src/preload/index.ts"
      to: "src/main/ipc/database.ts"
      via: "IPC channel names"
      pattern: "db:settings:"
---

<objective>
Add tags + settings tables to database. Add IPC handlers for CRUD operations.

Purpose: Data layer for user settings and tag management
Output: Tags and settings available via window.api
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-navigation/03-RESEARCH.md
@src/main/db/migrations.ts
@src/main/ipc/database.ts
@src/preload/index.ts
@src/shared/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add migration v2 for tags + settings</name>
  <files>src/main/db/migrations.ts</files>
  <action>
Add migration version 2 to migrations array in `src/main/db/migrations.ts`:

```typescript
{
  version: 2,
  up: (db) => {
    db.exec(`
      CREATE TABLE tags (
        id TEXT PRIMARY KEY,
        name TEXT NOT NULL UNIQUE,
        color TEXT NOT NULL DEFAULT '#6b7280',
        created_at TEXT NOT NULL DEFAULT (datetime('now'))
      );

      CREATE TABLE task_tags (
        task_id TEXT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
        tag_id TEXT NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
        PRIMARY KEY (task_id, tag_id)
      );

      CREATE TABLE settings (
        key TEXT PRIMARY KEY,
        value TEXT NOT NULL
      );

      CREATE INDEX idx_task_tags_task ON task_tags(task_id);
      CREATE INDEX idx_task_tags_tag ON task_tags(tag_id);
    `)
  }
}
```

Junction table (task_tags) enables many-to-many tag assignment. Settings is simple key-value.
  </action>
  <verify>Migration runs on app start. `sqlite3 focus-dev.db ".tables"` shows tags, task_tags, settings tables.</verify>
  <done>Database has tags, task_tags, settings tables</done>
</task>

<task type="auto">
  <name>Task 2: Add types and IPC handlers for tags + settings</name>
  <files>src/shared/types/database.ts, src/shared/types/api.ts, src/main/ipc/database.ts, src/preload/index.ts</files>
  <action>
1. Add to `src/shared/types/database.ts`:
```typescript
export interface Tag {
  id: string
  name: string
  color: string
  created_at: string
}
```

2. Add to `src/shared/types/api.ts`:
```typescript
// Import Tag
import type { Task, Project, Tag, TaskStatus } from './database'

// Add input types
export interface CreateTagInput {
  name: string
  color?: string
}

export interface UpdateTagInput {
  id: string
  name?: string
  color?: string
}

// Extend ElectronAPI.db:
tags: {
  getTags: () => Promise<Tag[]>
  createTag: (data: CreateTagInput) => Promise<Tag>
  updateTag: (data: UpdateTagInput) => Promise<Tag>
  deleteTag: (id: string) => Promise<boolean>
}
settings: {
  get: (key: string) => Promise<string | null>
  set: (key: string, value: string) => Promise<void>
  getAll: () => Promise<Record<string, string>>
}
```

3. Add IPC handlers to `src/main/ipc/database.ts`:
```typescript
// Tags
ipcMain.handle('db:tags:getAll', () => {
  return db.prepare('SELECT * FROM tags ORDER BY name').all()
})

ipcMain.handle('db:tags:create', (_, data: CreateTagInput) => {
  const id = crypto.randomUUID()
  db.prepare('INSERT INTO tags (id, name, color) VALUES (?, ?, ?)')
    .run(id, data.name, data.color ?? '#6b7280')
  return db.prepare('SELECT * FROM tags WHERE id = ?').get(id)
})

ipcMain.handle('db:tags:update', (_, data: UpdateTagInput) => {
  const fields: string[] = []
  const values: unknown[] = []
  if (data.name !== undefined) { fields.push('name = ?'); values.push(data.name) }
  if (data.color !== undefined) { fields.push('color = ?'); values.push(data.color) }
  if (fields.length > 0) {
    values.push(data.id)
    db.prepare(`UPDATE tags SET ${fields.join(', ')} WHERE id = ?`).run(...values)
  }
  return db.prepare('SELECT * FROM tags WHERE id = ?').get(data.id)
})

ipcMain.handle('db:tags:delete', (_, id: string) => {
  return db.prepare('DELETE FROM tags WHERE id = ?').run(id).changes > 0
})

// Settings
ipcMain.handle('db:settings:get', (_, key: string) => {
  const row = db.prepare('SELECT value FROM settings WHERE key = ?').get(key) as { value: string } | undefined
  return row?.value ?? null
})

ipcMain.handle('db:settings:set', (_, key: string, value: string) => {
  db.prepare('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)').run(key, value)
})

ipcMain.handle('db:settings:getAll', () => {
  const rows = db.prepare('SELECT key, value FROM settings').all() as { key: string; value: string }[]
  return Object.fromEntries(rows.map(r => [r.key, r.value]))
})
```

4. Add to preload `src/preload/index.ts`:
```typescript
// Inside api object:
tags: {
  getTags: () => ipcRenderer.invoke('db:tags:getAll'),
  createTag: (data) => ipcRenderer.invoke('db:tags:create', data),
  updateTag: (data) => ipcRenderer.invoke('db:tags:update', data),
  deleteTag: (id) => ipcRenderer.invoke('db:tags:delete', id),
},
settings: {
  get: (key) => ipcRenderer.invoke('db:settings:get', key),
  set: (key, value) => ipcRenderer.invoke('db:settings:set', key, value),
  getAll: () => ipcRenderer.invoke('db:settings:getAll'),
}
```
  </action>
  <verify>`npm run dev`, open devtools, run `await window.api.tags.getTags()` returns []. Run `await window.api.settings.set('test', 'value')` then `await window.api.settings.get('test')` returns 'value'.</verify>
  <done>Tags and settings CRUD available via window.api</done>
</task>

</tasks>

<verification>
1. App starts without errors (migration runs)
2. DevTools console: `window.api.tags.getTags()` returns empty array
3. DevTools console: `window.api.settings.set('k', 'v')` then `window.api.settings.get('k')` returns 'v'
4. `npm run typecheck` passes
</verification>

<success_criteria>
- Migration v2 creates tags, task_tags, settings tables
- Tag type defined in database.ts
- Tags CRUD handlers + preload wiring complete
- Settings get/set handlers + preload wiring complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-navigation/03-02-SUMMARY.md`
</output>
